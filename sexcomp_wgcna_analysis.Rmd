```{r}
library(tidyverse)
library(gprofiler2)
library(dplyr)
library(ggplot2)
library(WGCNA)
load("eigengenes_spearman_5_sexchr.Rdata")
load("sex_comp_combat_adj_pheno.RData")
load("log_PFAS_pheno.Rdata")
load("annotation_file.RData")

```

```{r}
#("G-155","G-157") are not in the pfas data
#removing ID G-174 because it is not matching correctly with male sex
# "G-247" "G-316" "G-411" are not in pheno data but in pfas data
exclude_ids <- c("G-155","G-157", "G-247", "G-316", "G-411", "G-174")
pheno_150 <- pheno_150[!pheno_150$participant_id %in% exclude_ids, ]
rownames(pheno_150) <- pheno_150$participant_id
sex_comp_combat.adj <- sex_comp_combat.adj[, !colnames(sex_comp_combat.adj) %in% exclude_ids]
log_pfas = log_pfas[!rownames(log_pfas) %in% exclude_ids,]
combat.adj = t(sex_comp_combat.adj)
#rownames(combat.adj) == rownames(log_pfas) TRUE !
pc <- prcomp(combat.adj)$x
pheno_150$PC1 = pc[,"PC1"]
log_pfas <- log_pfas %>%
rename_with(~ str_replace_all(.x, "-", "_"))   # "L-PFOA" -> "L_PFOA"
# Append PFAS values to phenotype data
pfas_vars <- c("L_PFOA","PFHxS","PFNA","PFDA","s_PFOS")
pheno_150 <- cbind(pheno_150, log_pfas[, pfas_vars])
#subsetting
eigengenes = module_Eigengenes$eigengenes
eigengenes = eigengenes[(rownames(eigengenes) %in% rownames(log_pfas)),]
```

```{r}
load("~/Desktop/ViCTER_maternal_environment_2024-05-29.RData")
weight =  wide_pfas_modeling %>%
filter(id %in% pheno_150$participant_id) %>%
dplyr::select(id, gwg_kg) %>%
rename(participant_id = id)
pheno_150= merge(pheno_150, weight, by = "participant_id")
pheno_150 = pheno_150 %>% dplyr::select(participant_id, L_PFOA,PFHxS,PFNA,PFDA,s_PFOS, PC1, mom_age_at_birth, mom_education, gest_age_in_weeks_edd, gwg_kg, childs_sex, official_enroll_category, delivery_method, birth_len_cm, birth_wt_kg)
eigengenes$participant_id = rownames(eigengenes)
pheno <- left_join(pheno_150, eigengenes, by = "participant_id")
rm(list = ls()[!ls() %in% c("pheno", "eigengenes", "gene_color", "combat.adj" )])
```
#regression analysis y = birth outcome (birth length, birth weight, gestational age), x = module eigengene 
```{r}
ME = colnames(eigengenes)[1:20]
birthoutcomes = c("birth_len_cm", "birth_wt_kg", "gest_age_in_weeks_edd")
results_list_birth = list()
for(outcome in birthoutcomes){
out <- vector("list", length(ME))
for ( k in 1:length(ME)) {
pf <- ME[k]
if( outcome == "gest_age_in_weeks_edd"){
form <- reformulate(
c(
pf,
"mom_age_at_birth",
"mom_education",
"official_enroll_category",
"gwg_kg",
"PC1"
),
response = outcome
)
} else {
form <- reformulate(
c(
pf,
"mom_age_at_birth",
"mom_education",
"official_enroll_category",
"gest_age_in_weeks_edd",
"gwg_kg",
"PC1"
),
response = outcome
)
}
model <- lm(form, data = pheno)
coef_mat <- coef(summary(model))
#ci <- confint(model)[pf, ]
out[[k]] <- data.frame(
birth_outcome = outcome,
ME      =  pf,
estimate  = coef_mat[pf, "Estimate"],
#conf.low  = ci[1],
# conf.high = ci[2],
p.value   = coef_mat[pf, "Pr(>|t|)"],
row.names = NULL
)
}
results_list_birth[[outcome]] <- bind_rows(out)
}
results_list_birth$birth_len_cm$q.value = p.adjust(results_list_birth$birth_len_cm$p.value, method = "fdr", n =20)
results_list_birth$birth_wt_kg$q.value = p.adjust(results_list_birth$birth_wt_kg$p.value, method = "fdr", n =20)
results_list_birth$gest_age_in_weeks_edd$q.value = p.adjust(results_list_birth$gest_age_in_weeks_edd$p.value, method = "fdr", n =20)
results_list_birth
```
#identifying hub gene 
```{r}

chooseTopHubInEachModule(datExpr = combat.adj, colorh = gene_color$color, power = 5, type = "signed")

```
#regression analysis y = module eigengene, x = PFAS
```{r}
ME <- colnames(eigengenes)[1:20]
pfas_vars <- c("L_PFOA","PFHxS","PFNA","PFDA","s_PFOS")
results_list_pfas = list()
for(pf in pfas_vars){
out <- vector("list", length(ME))
for ( k in 1:length(ME)) {
module <- ME[k]

form <- reformulate(
c(
pf,
"mom_age_at_birth",
"mom_education",
"official_enroll_category",
"gest_age_in_weeks_edd",
"gwg_kg",
"PC1"
),
response = module
)

model <- lm(form, data = pheno)
coef_mat <- coef(summary(model))
#ci <- confint(model)[pf, ]
out[[k]] <- data.frame(
pfas = pf,
ME      =  module,
estimate  = coef_mat[pf, "Estimate"],
#conf.low  = ci[1],
# conf.high = ci[2],
p.value   = coef_mat[pf, "Pr(>|t|)"],
row.names = NULL
)
}
results_list_pfas[[pf]] <- bind_rows(out)
}

results_list_pfas$L_PFOA$q.value = p.adjust(results_list_pfas$L_PFOA$p.value, method = "fdr", n =20)
results_list_pfas$PFHxS$q.value = p.adjust(results_list_pfas$PFHxS$p.value, method = "fdr", n =20)
results_list_pfas$PFNA$q.value = p.adjust(results_list_pfas$PFNA$p.value, method = "fdr", n =20)
results_list_pfas$PFDA$q.value = p.adjust(results_list_pfas$PFDA$p.value, method = "fdr", n =20)
results_list_pfas$s_PFOS$q.value = p.adjust(results_list_pfas$s_PFOS$p.value, method = "fdr", n =20)
```

#gene expression heat map 
```{r}
library(pheatmap)
color_palette <- colorRampPalette(c("green", "black", "red"))(100)
sex_data <- factor(pheno$childs_sex)
annotation_df <- data.frame(Sex = sex_data)
rownames(annotation_df) <- pheno$participant_id
sex_colors <- list(Sex= c(Male = "blue", Female = "pink"))
gene_data <- t(combat.adj[pheno$participant_id,gene_color[which(gene_color$color == "lightgreen"),"gene_name"]])
lightgreen = gene_color[which(gene_color$color == "lightgreen"),]$gene_name

seqnames = gene_info %>% filter(.$gene_name %in% lightgreen) %>% select(seqnames, gene_name) %>% arrange(seqnames, .by_group = TRUE)

colnames(seqnames) = c("chr", "gene_name")
gene_data <- gene_data[seqnames$gene_name, ]

unique_seqnames <- unique(seqnames$chr)
seqname_colors <- colorRampPalette(c("purple", "orange", "cyan"))(length(unique_seqnames))
names(seqname_colors) <- unique_seqnames

# Create an annotation for row colors (gene names by seqname)
row_annotation <- data.frame(chr = seqnames$chr)
rownames(row_annotation) <- seqnames$gene_name

# Assign the seqname colors for rows
annotation_colors <- list(chr = seqname_colors)



pheatmap(gene_data, 
         annotation_col = annotation_df, 
         annotation_colors = sex_colors,
         annotation_row = row_annotation,
         scale = "row", 
         #color = color_palette, 
         clustering_method = "complete",
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         show_rownames = TRUE,
         show_colnames = F,
         cluster_rows = F)
```

#TF network enrichment 
```{r}
TF_enrichment = data.frame()
load("DataFile_FinalTRN.RData")


for (i in unique(gene_color$color)){
  if (i != "grey") {
  color = gene_color %>% filter(color == i) %>% pull(gene_name)
  TFN = TRNModel %>% filter(.$targetGene %in% color) 
  sorted_df = sort(table(TFN$TF), decreasing = TRUE)
  sorted_df = as.data.frame(sorted_df)
  colnames(sorted_df) = c("Variable", "Count")
in_module = sorted_df[1, "Variable"] %in% color
  
  ppars = sorted_df %>% filter(grepl("PPAR", Variable)) # identifying if there are PPAR TF because it is a molecular mechanism of interest 
  if(nrow(ppars) == 0){
     df= data.frame(top_TF = sorted_df[1, "Variable"], PPARA = 0, PPARD = 0, PPARG = 0, top_TF_module= in_module,  top_TF_num = sorted_df[1, "Count"], module = i)
  } else {
    rownames(ppars) = ppars$Variable
    df= data.frame(top_TF = sorted_df[1, "Variable"], PPARA = ppars["PPARA","Count"], PPARD = ppars["PPARD","Count"], PPARG =ppars["PPARG","Count"], top_TF_module= in_module, top_TF_num = sorted_df[1, "Count"], module = i)
  }
  
TF_enrichment  = rbind(TF_enrichment, df)
} }


TF_enrichment[is.na(TF_enrichment)] <- 0

TF_enrichment
```
```

